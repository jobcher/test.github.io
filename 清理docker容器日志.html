<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<link media="all" rel="stylesheet" href="./css/style.css">

<script src="./js/style.js"></script>



    <title>清理Docker容器日志 - 打工人日志</title>
</head>

<body>
    <div class="header-box">
    <img src="https://test.jobcher.com/images/logo.webp" id="logo" alt="logo" class="logo">
    <h1><a href="https://test.jobcher.com">打工人日志</a></h1>
</div>
<nav class="nav">
    <ul>
        
            <li>
                <a href="./">首页</a>
                
            </li>
        
            <li>
                <a href="https://nav.jobcher.com/">导航</a>
                
            </li>
        
            <li>
                <a href="./posts/about">关于</a>
                
            </li>
        
    </ul>
</nav>
    <div id="post" class="post">
        <header>
            <h2 class="post-title">清理Docker容器日志</h2>
            
        </header>
        <article class="article">
                <div class="single-content">
                    <h1 id="清理-docker-容器日志">清理 Docker 容器日志</h1>
<p>如果 docker 容器正在运行，那么使用<code>rm -rf</code>方式删除日志后，通过<code>df -h</code>会发现磁盘空间并没有释放。原因是在 Linux 或者 Unix 系统中，通过<code>rm -rf</code>或者文件管理器删除文件，将会从文件系统的目录结构上解除链接（unlink）。如果文件是被打开的（有一个进程正在使用），那么进程将仍然可以读取该文件，磁盘空间也一直被占用。正确姿势是<code>cat /dev/null &gt; *-json.log</code>，当然你也可以通过<code>rm -rf</code>删除后重启 docker。</p>
<h2 id="日志清理脚本-clean_docker_logsh">日志清理脚本 clean_docker_log.sh</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/sh
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;======== start clean docker containers logs ========&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>logs<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>find /var/lib/docker/containers/ -name *-json.log<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> log in $logs
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>                echo <span style="color:#e6db74">&#34;clean logs : </span>$log<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>                cat /dev/null &gt; $log
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;======== end clean docker containers logs ========&#34;</span>
</span></span></code></pre></div><blockquote>
<p>chmod +x clean_docker_log.sh &amp;&amp; ./clean_docker_log.sh</p>
</blockquote>
<h2 id="设置-docker-容器日志大小">设置 Docker 容器日志大小</h2>
<p>设置一个容器服务的日志大小上限<br>
上述方法，日志文件迟早又会涨回来。要从根本上解决问题，需要限制容器服务的日志大小上限。这个通过配置容器<code>docker-compose</code>的<code>max-size</code>选项来实现</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">nginx</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.12.1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">logging</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">driver</span>: <span style="color:#ae81ff">“json-file”</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">options</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">max-size</span>: <span style="color:#ae81ff">“5g”</span>
</span></span></code></pre></div><h3 id="全局设置">全局设置</h3>
<p>新建<code>/etc/docker/daemon.json</code>，若有就不用新建了。添加<code>log-dirver</code>和<code>log-opts</code>参数</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">vim</span> <span style="color:#960050;background-color:#1e0010">/etc/docker/daemon.json</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;log-driver&#34;</span>:<span style="color:#e6db74">&#34;json-file&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;log-opts&#34;</span>: {<span style="color:#f92672">&#34;max-size&#34;</span>:<span style="color:#e6db74">&#34;500m&#34;</span>, <span style="color:#f92672">&#34;max-file&#34;</span>:<span style="color:#e6db74">&#34;3&#34;</span>}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>max-size=500m</code>，意味着一个容器日志大小上限是<code>500M</code><br>
<code>max-file=3</code>，意味着一个容器有三个日志，分别是<code>id+.json</code>、<code>id+1.json</code>、<code>id+2.json</code>。</p>
<blockquote>
<p>注意：设置的日志大小，只对新建的容器有效。</p>
</blockquote>

                </div>
            <br />
        <div>
                
                <a href="https://test.jobcher.com/headscale-%E9%83%A8%E7%BD%B2%E4%BD%BF%E7%94%A8.html" class="prev">前一页</a>
                
                
                <a href="https://test.jobcher.com/%E7%BE%8A%E4%BA%86%E4%B8%AA%E7%BE%8A%E5%B0%8F%E7%A8%8B%E5%BA%8F-%E7%A0%B4%E8%A7%A3%E9%80%9A%E5%85%B3.html" class="next">后一页</a>
                
            </div>
        </article>
    </div>

    <nav class="footer-nav">
        <ul>
            
            <li><a href="./posts/about">关于我们</a></li>
            
            <li><a href="./">网站首页</a></li>
            
            <li><a href=""></a></li>
            
        </ul>
    </nav>
    <footer class="footer">
    <span style="color: aliceblue;">© 2019-2023 by jobcher</span>
</footer>
</body>

</html>