<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<link media="all" rel="stylesheet" href="./css/style.css">

<script src="./js/style.js"></script>



    <title>nginx 日志格式整理 - 打工人日志</title>
</head>

<body>
    <div class="header-box">
    <img src="https://test.jobcher.com/images/logo.webp" id="logo" alt="logo" class="logo">
    <h1><a href="https://test.jobcher.com">打工人日志</a></h1>
</div>
<nav class="nav">
    <ul>
        
            <li>
                <a href="./">首页</a>
                
            </li>
        
            <li>
                <a href="https://nav.jobcher.com/">导航</a>
                
            </li>
        
            <li>
                <a href="./%E5%85%B3%E4%BA%8E%E6%88%91.html">关于</a>
                
            </li>
        
    </ul>
</nav>
    <div id="post" class="post">
        <header>
            <h2 class="post-title">nginx 日志格式整理</h2>
            
        </header>
        <article class="article">
                <div class="single-content">
                    <h1 id="nginx-日志配置">nginx 日志配置</h1>
<h2 id="语法">语法</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-conf" data-lang="conf"><span style="display:flex;"><span>access_log path <span style="color:#960050;background-color:#1e0010">[</span>format <span style="color:#960050;background-color:#1e0010">[</span>buffer<span style="color:#f92672">=</span>size<span style="color:#960050;background-color:#1e0010">]</span> <span style="color:#960050;background-color:#1e0010">[</span>gzip<span style="color:#960050;background-color:#1e0010">[</span><span style="color:#f92672">=</span>level<span style="color:#960050;background-color:#1e0010">]]</span> <span style="color:#960050;background-color:#1e0010">[</span>flush<span style="color:#f92672">=</span>time<span style="color:#960050;background-color:#1e0010">]</span> <span style="color:#960050;background-color:#1e0010">[</span><span style="color:#66d9ef">if</span><span style="color:#f92672">=</span>condition<span style="color:#960050;background-color:#1e0010">]]</span>; <span style="color:#75715e"># 设置访问日志
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>access_log <span style="color:#66d9ef">off</span>; <span style="color:#75715e"># 关闭访问日志
</span></span></span></code></pre></div><p>例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-conf" data-lang="conf"><span style="display:flex;"><span>access_log <span style="color:#960050;background-color:#1e0010">/</span>var<span style="color:#960050;background-color:#1e0010">/</span>logs<span style="color:#960050;background-color:#1e0010">/</span>nginx-access.log
</span></span><span style="display:flex;"><span>access_log <span style="color:#960050;background-color:#1e0010">/</span>var<span style="color:#960050;background-color:#1e0010">/</span>logs<span style="color:#960050;background-color:#1e0010">/</span>nginx-access.log buffer<span style="color:#f92672">=</span>32k gzip flush<span style="color:#f92672">=</span>1m
</span></span></code></pre></div><h2 id="使用-log_format-自定义日志格式">使用 log_format 自定义日志格式</h2>
<p>Nginx 预定义了名为 combined 日志格式，如果没有明确指定日志格式默认使用该格式：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-conf" data-lang="conf"><span style="display:flex;"><span>log_format combined <span style="color:#960050;background-color:#1e0010">&#39;$</span>remote_addr - <span style="color:#960050;background-color:#1e0010">$</span>remote_user <span style="color:#960050;background-color:#1e0010">[$</span>time_local<span style="color:#960050;background-color:#1e0010">]</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#e6db74">&#34;$request&#34;</span> <span style="color:#960050;background-color:#1e0010">$</span>status <span style="color:#960050;background-color:#1e0010">$</span>body_bytes_sent <span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#e6db74">&#34;$http_referer&#34;</span> <span style="color:#e6db74">&#34;$http_user_agent&#34;</span><span style="color:#960050;background-color:#1e0010">&#39;</span>;
</span></span></code></pre></div><p>如果不想使用 Nginx 预定义的格式，可以通过 log_format 指令来自定义。</p>
<h3 id="语法-1">语法</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-conf" data-lang="conf"><span style="display:flex;"><span>log_format name <span style="color:#960050;background-color:#1e0010">[</span>escape<span style="color:#f92672">=</span>default<span style="color:#960050;background-color:#1e0010">|</span>json<span style="color:#960050;background-color:#1e0010">]</span> string ...;
</span></span></code></pre></div><table>
<thead>
<tr>
<th style="text-align:left">变量</th>
<th style="text-align:left">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">$bytes_sent</td>
<td style="text-align:left">发送给客户端的总字节数</td>
</tr>
<tr>
<td style="text-align:left">$body_bytes_sent</td>
<td style="text-align:left">发送给客户端的字节数，不包括响应头的大小</td>
</tr>
<tr>
<td style="text-align:left">$connection</td>
<td style="text-align:left">连接序列号</td>
</tr>
<tr>
<td style="text-align:left">$connection_requests</td>
<td style="text-align:left">当前通过连接发出的请求数量</td>
</tr>
<tr>
<td style="text-align:left">$msec</td>
<td style="text-align:left">日志写入时间，单位为秒，精度是毫秒</td>
</tr>
<tr>
<td style="text-align:left">$pipe</td>
<td style="text-align:left">如果请求是通过 http 流水线发送，则其值为&quot;p&quot;，否则为“.&quot;</td>
</tr>
<tr>
<td style="text-align:left">$request_length</td>
<td style="text-align:left">请求长度（包括请求行，请求头和请求体）</td>
</tr>
<tr>
<td style="text-align:left">$request_time</td>
<td style="text-align:left">请求处理时长，单位为秒，精度为毫秒，从读入客户端的第一个字节开始，直到把最后一个字符发送张客户端进行日志写入为止</td>
</tr>
<tr>
<td style="text-align:left">$status</td>
<td style="text-align:left">响应状态码</td>
</tr>
<tr>
<td style="text-align:left">$time_iso8601</td>
<td style="text-align:left">标准格式的本地时间,形如“2017-05-24T18:31:27+08:00”</td>
</tr>
<tr>
<td style="text-align:left">$time_local</td>
<td style="text-align:left">通用日志格式下的本地时间，如&quot;24/May/2017:18:31:27 +0800&quot;</td>
</tr>
<tr>
<td style="text-align:left">$http_referer</td>
<td style="text-align:left">请求的 referer 地址。</td>
</tr>
<tr>
<td style="text-align:left">$http_user_agent</td>
<td style="text-align:left">客户端浏览器信息。</td>
</tr>
<tr>
<td style="text-align:left">$remote_addr</td>
<td style="text-align:left">客户端 IP</td>
</tr>
<tr>
<td style="text-align:left">$http_x_forwarded_for</td>
<td style="text-align:left">当前端有代理服务器时，设置 web 节点记录客户端地址的配置，此参数生效的前提是代理服务器也要进行相关的 x_forwarded_for 设置。</td>
</tr>
<tr>
<td style="text-align:left">$request</td>
<td style="text-align:left">完整的原始请求行，如 &ldquo;GET / HTTP/1.1&rdquo;</td>
</tr>
<tr>
<td style="text-align:left">$remote_user</td>
<td style="text-align:left">客户端用户名称，针对启用了用户认证的请求</td>
</tr>
<tr>
<td style="text-align:left">$request_uri</td>
<td style="text-align:left">完整的请求地址，如 &ldquo;<a href="https://daojia.com/%22">https://daojia.com/&quot;</a></td>
</tr>
</tbody>
</table>
<p>例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-conf" data-lang="conf"><span style="display:flex;"><span>access_log <span style="color:#960050;background-color:#1e0010">/</span>var<span style="color:#960050;background-color:#1e0010">/</span>logs<span style="color:#960050;background-color:#1e0010">/</span>nginx-access.log main
</span></span><span style="display:flex;"><span>log_format  main  <span style="color:#960050;background-color:#1e0010">&#39;$</span>remote_addr - <span style="color:#960050;background-color:#1e0010">$</span>remote_user <span style="color:#960050;background-color:#1e0010">[$</span>time_local<span style="color:#960050;background-color:#1e0010">]</span> <span style="color:#e6db74">&#34;$request&#34;</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#960050;background-color:#1e0010">&#39;$</span>status <span style="color:#960050;background-color:#1e0010">$</span>body_bytes_sent <span style="color:#e6db74">&#34;$http_referer&#34;</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#e6db74">&#34;$http_user_agent&#34;</span> <span style="color:#e6db74">&#34;$http_x_forwarded_for&#34;</span><span style="color:#960050;background-color:#1e0010">&#39;</span>;
</span></span></code></pre></div>
                </div>
            <br />
        <div>
                
                <a href="https://test.jobcher.com/kubernetes-%E5%88%9B%E5%BB%BAnfs%E5%AD%98%E5%82%A8%E7%B1%BB.html" class="prev">前一页</a>
                
                
                <a href="https://test.jobcher.com/linux%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%90%AFroot%E6%9D%83%E9%99%90.html" class="next">后一页</a>
                
            </div>
        </article>
    </div>

    <nav class="footer-nav">
        <ul>
            
            <li><a href="./%E5%85%B3%E4%BA%8E%E6%88%91.html">关于我们</a></li>
            
            <li><a href="./">网站首页</a></li>
            
            <li><a href=""></a></li>
            
        </ul>
    </nav>
    <footer class="footer">
    <span style="color: aliceblue;">© 2019-2023 by jobcher</span>
</footer>
</body>

</html>