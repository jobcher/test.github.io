<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<link media="all" rel="stylesheet" href="./css/style.css">

<script src="./js/style.js"></script>



    <title>Kubernetes — 更新证书 - 打工人日志</title>
</head>

<body>
    <div class="header-box">
    <img src="https://test.jobcher.com/images/logo.webp" id="logo" alt="logo" class="logo">
    <h1><a href="https://test.jobcher.com">打工人日志</a></h1>
</div>
<nav class="nav">
    <ul>
        
            <li>
                <a href="./">首页</a>
                
            </li>
        
            <li>
                <a href="./posts">文章</a>
                
            </li>
        
            <li>
                <a href="https://nav.jobcher.com/">导航</a>
                
            </li>
        
            <li>
                <a href="./posts/about">关于</a>
                
            </li>
        
    </ul>
</nav>
    <div id="post" class="post">
        <header>
            <h2 class="post-title">Kubernetes — 更新证书</h2>
            
                <img src="./images/k8s.png" alt="Kubernetes — 更新证书" class="featured-image">
            
        </header>
        <article class="article">
                <div class="single-content">
                    <h2 id="背景">背景</h2>
<p>使用 <code>kubeadm</code> 安装 <code>kubernetes</code> 集群非常方便，但是也有一个比较烦人的问题就是默认的证书有效期只有<code>一年</code>时间，所以需要考虑<code>证书升级</code>的问题</p>
<h2 id="检查证书">检查证书</h2>
<p>由 kubeadm 生成的客户端证书默认只有一年有效期，我们可以通过 check-expiration 命令来检查证书是否过期：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubeadm alpha certs check-expiration
</span></span></code></pre></div><p>该命令显示 <code>/etc/kubernetes/pki</code> 文件夹中的客户端证书以及 <code>kubeadm</code> 使用的 <code>KUBECONFIG</code> 文件中嵌入的客户端证书的<code>到期时间</code>/<code>剩余时间</code>。</p>
<h2 id="手动更新">手动更新</h2>
<blockquote>
<p>kubeadm alpha certs renew<br>
这个命令用 CA（或者 front-proxy-CA ）证书和存储在 <code>/etc/kubernetes/pki</code> 中的密钥执行更新。<br>
高可用的集群，这个命令需要在所有控制面板节点上执行</p>
</blockquote>
<h3 id="具体执行">具体执行</h3>
<p>接下来我们来更新我们的集群证书，下面的操作都是在 master 节点上进行</p>
<ol>
<li>备份节点</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ mkdir /etc/kubernetes.bak
</span></span><span style="display:flex;"><span>$ cp -r /etc/kubernetes/pki/ /etc/kubernetes.bak
</span></span><span style="display:flex;"><span>$ cp /etc/kubernetes/*.conf /etc/kubernetes.bak
</span></span></code></pre></div><ol start="2">
<li>备份 etcd 数据目录</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cp -r /var/lib/etcd /var/lib/etcd.bak
</span></span></code></pre></div><ol start="3">
<li>执行更新证书的命令</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubeadm alpha certs renew all --config<span style="color:#f92672">=</span>kubeadm.yaml
</span></span></code></pre></div><ol start="4">
<li>检查更新</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubeadm alpha certs check-expiration
</span></span></code></pre></div><ol start="5">
<li>更新下 kubeconfig 文件</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubeadm init phase kubeconfig all --config kubeadm.yaml
</span></span></code></pre></div><ol start="6">
<li>覆盖掉原本的 admin 文件</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ mv $HOME/.kube/config $HOME/.kube/config.old
</span></span><span style="display:flex;"><span>$ cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style="display:flex;"><span>$ chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config
</span></span></code></pre></div><ol start="7">
<li>重启 kube-apiserver、kube-controller、kube-scheduler、etcd ,查看 apiserver 的证书的有效期</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>echo | openssl s_client -showcerts -connect 127.0.0.1:6443 -servername api 2&gt;/dev/null | openssl x509 -noout -enddate
</span></span></code></pre></div><h2 id="总结">总结</h2>
<p>可以看到现在的有效期是一年过后的，证明已经更新成功了。</p>

                </div>
            <br />
        <div>
                
                <a href="https://test.jobcher.com/jenkins-%E7%BC%96%E8%AF%91android-apk-%E6%B5%81%E6%B0%B4%E7%BA%BF.html" class="prev">前一页</a>
                
                
                <a href="https://test.jobcher.com/oracle-instant-client-%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E5%AE%9E%E7%8E%B0%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5oracle.html" class="next">后一页</a>
                
            </div>
        </article>
    </div>

    <nav class="footer-nav">
        <ul>
            
            <li><a href="./posts/about">关于我们</a></li>
            
            <li><a href="./posts">博文合集</a></li>
            
            <li><a href="./">网站首页</a></li>
            
        </ul>
    </nav>
    <footer class="footer">
    <span style="color: aliceblue;">© 2019-2023 by jobcher</span>
</footer>
</body>

</html>