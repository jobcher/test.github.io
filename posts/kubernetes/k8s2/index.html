<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<link media="all" rel="stylesheet" href="/css/style.css">

<script src="/js/style.js"></script>
    <title>Kubernetes 安装</title>
</head>

<body>
    <div class="header-box">
    <img src="https://test.jobcher.com/images/logo.webp" id="logo" alt="logo" class="logo">
    <h1><a href="https://test.jobcher.com">打工人日志</a></h1>
</div>
<nav class="nav">
    <ul>
        
            <li>
                <a href="/">首页</a>
                
            </li>
        
            <li>
                <a href="/posts">文章</a>
                
            </li>
        
            <li>
                <a href="https://nav.jobcher.com/">导航</a>
                
            </li>
        
            <li>
                <a href="/posts/about">关于</a>
                
            </li>
        
    </ul>
</nav>
    <div id="post" class="post">
        <header>
            <h2 class="post-title">Kubernetes 安装</h2>
            
        </header>
        <article class="article">
                <div class="single-content">
                    <h1 id="kubernetes-安装">Kubernetes 安装</h1>
<h2 id="环境配置">环境配置</h2>
<h3 id="关闭防火墙-如果是云服务器需要设置安全组策略放行端口">关闭防火墙： 如果是云服务器，需要设置安全组策略放行端口</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>systemctl stop firewalld
</span></span><span style="display:flex;"><span>systemctl disable firewalld
</span></span></code></pre></div><h3 id="修改-hostname">修改 hostname</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>hostnamectl set-hostname k8s-01
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;127.0.0.1   </span><span style="color:#66d9ef">$(</span>hostname<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> &gt;&gt; /etc/hosts
</span></span><span style="display:flex;"><span>reboot
</span></span></code></pre></div><h3 id="关闭-selinux">关闭 selinux：</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#39;s/enforcing/disabled/&#39;</span> /etc/selinux/config
</span></span><span style="display:flex;"><span>setenforce <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><h3 id="关闭-swap">关闭 swap：</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>swapoff -a
</span></span><span style="display:flex;"><span>sed -ri <span style="color:#e6db74">&#39;s/.*swap.*/#&amp;/&#39;</span> /etc/fstab
</span></span></code></pre></div><h3 id="修改-etcsysctlconf">修改 /etc/sysctl.conf</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># 如果有配置，则修改</span>
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#34;s#^net.ipv4.ip_forward.*#net.ipv4.ip_forward=1#g&#34;</span>  /etc/sysctl.conf
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#34;s#^net.bridge.bridge-nf-call-ip6tables.*#net.bridge.bridge-nf-call-ip6tables=1#g&#34;</span>  /etc/sysctl.conf
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#34;s#^net.bridge.bridge-nf-call-iptables.*#net.bridge.bridge-nf-call-iptables=1#g&#34;</span>  /etc/sysctl.conf
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#34;s#^net.ipv6.conf.all.disable_ipv6.*#net.ipv6.conf.all.disable_ipv6=1#g&#34;</span>  /etc/sysctl.conf
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#34;s#^net.ipv6.conf.default.disable_ipv6.*#net.ipv6.conf.default.disable_ipv6=1#g&#34;</span>  /etc/sysctl.conf
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#34;s#^net.ipv6.conf.lo.disable_ipv6.*#net.ipv6.conf.lo.disable_ipv6=1#g&#34;</span>  /etc/sysctl.conf
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#34;s#^net.ipv6.conf.all.forwarding.*#net.ipv6.conf.all.forwarding=1#g&#34;</span>  /etc/sysctl.conf
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 可能没有，追加</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;net.ipv4.ip_forward = 1&#34;</span> &gt;&gt; /etc/sysctl.conf
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;net.bridge.bridge-nf-call-ip6tables = 1&#34;</span> &gt;&gt; /etc/sysctl.conf
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;net.bridge.bridge-nf-call-iptables = 1&#34;</span> &gt;&gt; /etc/sysctl.conf
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;net.ipv6.conf.all.disable_ipv6 = 1&#34;</span> &gt;&gt; /etc/sysctl.conf
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;net.ipv6.conf.default.disable_ipv6 = 1&#34;</span> &gt;&gt; /etc/sysctl.conf
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;net.ipv6.conf.lo.disable_ipv6 = 1&#34;</span> &gt;&gt; /etc/sysctl.conf
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;net.ipv6.conf.all.forwarding = 1&#34;</span>  &gt;&gt; /etc/sysctl.conf
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 执行命令以应用</span>
</span></span><span style="display:flex;"><span>sysctl -p
</span></span></code></pre></div><h2 id="安装-docker">安装 docker</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo yum remove docker*
</span></span><span style="display:flex;"><span>sudo yum install -y yum-utils
</span></span><span style="display:flex;"><span><span style="color:#75715e">#配置docker yum 源</span>
</span></span><span style="display:flex;"><span>sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
</span></span><span style="display:flex;"><span><span style="color:#75715e">#安装docker 19.03.9</span>
</span></span><span style="display:flex;"><span>yum install -y docker-ce-3:19.03.9-3.el7.x86_64  docker-ce-cli-3:19.03.9-3.el7.x86_64 containerd.io
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#安装docker 19.03.9   docker-ce  19.03.9</span>
</span></span><span style="display:flex;"><span>yum install -y docker-ce-19.03.9-3  docker-ce-cli-19.03.9 containerd.io
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#启动服务</span>
</span></span><span style="display:flex;"><span>systemctl start docker
</span></span><span style="display:flex;"><span>systemctl enable docker
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo systemctl daemon-reload
</span></span><span style="display:flex;"><span>sudo systemctl restart docker
</span></span></code></pre></div><h2 id="安装-k8s-核心都执行">安装 k8s 核心（都执行）</h2>
<h3 id="配置-k8s-的-yum-源">配置 K8S 的 yum 源</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[kubernetes]ß
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name=Kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enabled=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgcheck=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">repo_gpgcheck=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><h3 id="卸载旧版本安装新版本">卸载旧版本,安装新版本</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>yum remove -y kubelet kubeadm kubectl
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看可以安装的版本</span>
</span></span><span style="display:flex;"><span>yum list kubelet --showduplicates | sort -r
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装kubelet、kubeadm、kubectl 指定版本</span>
</span></span><span style="display:flex;"><span>yum install -y kubelet-1.21.0 kubeadm-1.21.0 kubectl-1.21.0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 开机启动kubelet</span>
</span></span><span style="display:flex;"><span>systemctl enable kubelet <span style="color:#f92672">&amp;&amp;</span> systemctl start kubelet
</span></span></code></pre></div><h2 id="初始化-master-节点">初始化 master 节点</h2>
<h3 id="创建-imagesshvim-imagessh粘贴以下命令">创建 images.sh,<code>vim images.sh</code>粘贴以下命令</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker pull k8s.gcr.io/kube-apiserver:v1.21.9
</span></span><span style="display:flex;"><span>docker pull k8s.gcr.io/kube-controller-manager:v1.21.9
</span></span><span style="display:flex;"><span>docker pull k8s.gcr.io/kube-scheduler:v1.21.9
</span></span><span style="display:flex;"><span>docker pull k8s.gcr.io/kube-proxy:v1.21.9
</span></span><span style="display:flex;"><span>docker pull k8s.gcr.io/pause:3.4.1
</span></span><span style="display:flex;"><span>docker pull k8s.gcr.io/etcd:3.4.13-0
</span></span><span style="display:flex;"><span>docker pull k8s.gcr.io/coredns/coredns:v1.8.0
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>chmod +x images.shß
</span></span><span style="display:flex;"><span>sh images.sh
</span></span></code></pre></div><h3 id="kubeadm-init-master-节点">kubeadm init master 节点</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubeadm init <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--apiserver-advertise-address<span style="color:#f92672">=</span>192.168.99.19 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubernetes-version v1.23.3 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--service-cidr<span style="color:#f92672">=</span>10.99.0.0/16 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--pod-network-cidr<span style="color:#f92672">=</span>10.124.0.0/16
</span></span></code></pre></div><h3 id="复制相关文件夹">复制相关文件夹</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>  mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style="display:flex;"><span>  sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config
</span></span></code></pre></div><h3 id="导出环境变量">导出环境变量</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>export KUBECONFIG<span style="color:#f92672">=</span>/etc/kubernetes/admin.conf
</span></span></code></pre></div><h3 id="部署一个-pod-网络">部署一个 pod 网络</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml
</span></span></code></pre></div><h3 id="命令检查">命令检查</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl get pod -A  <span style="color:#75715e">##获取集群中所有部署好的应用Pod</span>
</span></span><span style="display:flex;"><span>kubectl get nodes  <span style="color:#75715e">##查看集群所有机器的状态</span>
</span></span></code></pre></div><h2 id="初始化-worker-节点worker-执行">初始化 worker 节点（worker 执行）</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e">##过期怎么办</span>
</span></span><span style="display:flex;"><span>kubeadm token create --print-join-command
</span></span><span style="display:flex;"><span>kubeadm join --token y1eyw5.ylg568kvohfdsfco --discovery-token-ca-cert-hash sha256: 6c35e4f73f72afd89bf1c8c303ee55677d2cdb1342d67bb23c852aba2efc7c73
</span></span></code></pre></div><h3 id="验证集群">验证集群</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e">#获取所有节点</span>
</span></span><span style="display:flex;"><span>kubectl get nodes
</span></span></code></pre></div>
                </div>
            <br />
        <div>
                
                <a href="https://test.jobcher.com/posts/kubernetes/k8s3/" class="prev">前一页</a>
                
                
                <a href="https://test.jobcher.com/posts/base/linux1/" class="next">后一页</a>
                
            </div>
        </article>
    </div>

    <nav class="footer-nav">
        <ul>
            
            <li><a href="/posts/about">关于我们</a></li>
            
            <li><a href="/posts">博文合集</a></li>
            
            <li><a href="/">网站首页</a></li>
            
        </ul>
    </nav>
    <footer class="footer">
    <span style="color: aliceblue;">© 2019-2023 by jobcher</span>
</footer>
</body>

</html>