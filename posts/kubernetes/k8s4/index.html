<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<link media="all" rel="stylesheet" href="/css/style.css">

<script src="/js/style.js"></script>



    <title>kubernetes 脚本快速安装 - 打工人日志</title>
</head>

<body>
    <div class="header-box">
    <img src="https://www.jobcher.com/images/logo.webp" id="logo" alt="logo" class="logo">
    <h1><a href="https://www.jobcher.com">打工人日志</a></h1>
</div>
<nav class="nav">
    <ul>
        
            <li>
                <a href="/">首页</a>
                
            </li>
        
            <li>
                <a href="/posts">文章</a>
                
            </li>
        
            <li>
                <a href="https://nav.jobcher.com/">导航</a>
                
            </li>
        
            <li>
                <a href="/posts/about">关于</a>
                
            </li>
        
    </ul>
</nav>
    <div id="post" class="post">
        <header>
            <h2 class="post-title">kubernetes 脚本快速安装</h2>
            
        </header>
        <article class="article">
                <div class="single-content">
                    <h1 id="kubernetes-脚本快速安装">kubernetes 脚本快速安装</h1>
<ul>
<li>1、三台机器设置自己的 hostname（不能是 localhost）</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># 修改 hostname;  k8s-01要变为自己的hostname</span>
</span></span><span style="display:flex;"><span>hostnamectl set-hostname k8s-01
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置 hostname 解析</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;127.0.0.1   </span><span style="color:#66d9ef">$(</span>hostname<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> &gt;&gt; /etc/hosts
</span></span></code></pre></div><ul>
<li>
<p>2、所有机器批量执行如下脚本</p>
</li>
<li>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e">#先在所有机器执行 vi k8s.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 进入编辑模式（输入i），把如下脚本复制</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 所有机器给脚本权限  chmod +x k8s.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#执行脚本 ./k8s.sh</span>
</span></span></code></pre></div></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e">#/bin/sh</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#######################开始设置环境##################################### \n</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>printf <span style="color:#e6db74">&#34;##################正在配置所有基础环境信息################## \n&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>printf <span style="color:#e6db74">&#34;##################关闭selinux################## \n&#34;</span>
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#39;s/enforcing/disabled/&#39;</span> /etc/selinux/config
</span></span><span style="display:flex;"><span>setenforce <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>printf <span style="color:#e6db74">&#34;##################关闭swap################## \n&#34;</span>
</span></span><span style="display:flex;"><span>swapoff -a
</span></span><span style="display:flex;"><span>sed -ri <span style="color:#e6db74">&#39;s/.*swap.*/#&amp;/&#39;</span> /etc/fstab
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>printf <span style="color:#e6db74">&#34;##################配置路由转发################## \n&#34;</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">br_netfilter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#39;net.ipv4.ip_forward = 1&#39;</span> &gt;&gt; /etc/sysctl.d/k8s.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 必须 ipv6流量桥接</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#39;net.bridge.bridge-nf-call-ip6tables = 1&#39;</span> &gt;&gt; /etc/sysctl.d/k8s.conf
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 必须 ipv4流量桥接</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#39;net.bridge.bridge-nf-call-iptables = 1&#39;</span> &gt;&gt; /etc/sysctl.d/k8s.conf
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;net.ipv6.conf.all.disable_ipv6 = 1&#34;</span> &gt;&gt; /etc/sysctl.d/k8s.conf
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;net.ipv6.conf.default.disable_ipv6 = 1&#34;</span> &gt;&gt; /etc/sysctl.d/k8s.conf
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;net.ipv6.conf.lo.disable_ipv6 = 1&#34;</span> &gt;&gt; /etc/sysctl.d/k8s.conf
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;net.ipv6.conf.all.forwarding = 1&#34;</span>  &gt;&gt; /etc/sysctl.d/k8s.conf
</span></span><span style="display:flex;"><span>modprobe br_netfilter
</span></span><span style="display:flex;"><span>sudo sysctl --system
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>printf <span style="color:#e6db74">&#34;##################配置ipvs################## \n&#34;</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | sudo tee /etc/sysconfig/modules/ipvs.modules
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_rr
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_wrr
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- ip_vs_sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">modprobe -- nf_conntrack_ipv4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>chmod <span style="color:#ae81ff">755</span> /etc/sysconfig/modules/ipvs.modules
</span></span><span style="display:flex;"><span>sh /etc/sysconfig/modules/ipvs.modules
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>printf <span style="color:#e6db74">&#34;##################安装ipvsadm相关软件################## \n&#34;</span>
</span></span><span style="display:flex;"><span>yum install -y ipset ipvsadm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>printf <span style="color:#e6db74">&#34;##################安装docker容器环境################## \n&#34;</span>
</span></span><span style="display:flex;"><span>sudo yum remove docker*
</span></span><span style="display:flex;"><span>sudo yum install -y yum-utils
</span></span><span style="display:flex;"><span>sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
</span></span><span style="display:flex;"><span>yum install -y docker-ce-19.03.9  docker-ce-cli-19.03.9 containerd.io
</span></span><span style="display:flex;"><span>systemctl enable docker
</span></span><span style="display:flex;"><span>systemctl start docker
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo systemctl daemon-reload
</span></span><span style="display:flex;"><span>sudo systemctl restart docker
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>printf <span style="color:#e6db74">&#34;##################安装k8s核心包 kubeadm kubelet kubectl################## \n&#34;</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[kubernetes]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name=Kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enabled=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgcheck=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">repo_gpgcheck=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">###指定k8s安装版本</span>
</span></span><span style="display:flex;"><span>yum install -y kubelet-1.21.0 kubeadm-1.21.0 kubectl-1.21.0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">###要把kubelet立即启动。</span>
</span></span><span style="display:flex;"><span>systemctl enable kubelet
</span></span><span style="display:flex;"><span>systemctl start kubelet
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>printf <span style="color:#e6db74">&#34;##################下载api-server等核心镜像################## \n&#34;</span>
</span></span><span style="display:flex;"><span>sudo tee ./images.sh <span style="color:#e6db74">&lt;&lt;-&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker pull k8s.gcr.io/kube-apiserver:v1.21.9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker pull k8s.gcr.io/kube-controller-manager:v1.21.9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker pull k8s.gcr.io/kube-scheduler:v1.21.9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker pull k8s.gcr.io/kube-proxy:v1.21.9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker pull k8s.gcr.io/pause:3.4.1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker pull k8s.gcr.io/etcd:3.4.13-0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">docker pull k8s.gcr.io/coredns/coredns:v1.8.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>chmod +x ./images.sh <span style="color:#f92672">&amp;&amp;</span> ./images.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">### k8s的所有基本环境全部完成</span>
</span></span></code></pre></div><ul>
<li>3、使用 kubeadm 引导集群（参照初始化 master 继续做）</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#### --apiserver-advertise-address 的地址一定写成自己master机器的ip地址</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#### 虚拟机或者其他云厂商给你的机器ip  10.96  192.168</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#### 以下的只在master节点执行</span>
</span></span><span style="display:flex;"><span>kubeadm init <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--apiserver-advertise-address<span style="color:#f92672">=</span>10.12.12.24 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--kubernetes-version v1.21.0 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--service-cidr<span style="color:#f92672">=</span>10.96.0.0/16 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--pod-network-cidr<span style="color:#f92672">=</span>10.124.0.0/16
</span></span></code></pre></div><ul>
<li>4、master 结束以后，按照控制台引导继续往下</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e">## 第一步</span>
</span></span><span style="display:flex;"><span>mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style="display:flex;"><span>sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##第二步</span>
</span></span><span style="display:flex;"><span>export KUBECONFIG<span style="color:#f92672">=</span>/etc/kubernetes/admin.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##第三步 部署网络插件</span>
</span></span><span style="display:flex;"><span>kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##第四步，用控制台打印的kubeadm join 去其他node节点执行</span>
</span></span><span style="display:flex;"><span>kubeadm join 10.170.11.8:6443 --token cnb7x2.lzgz7mfzcjutn0nk <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	--discovery-token-ca-cert-hash sha256:00c9e977ee52632098aadb515c90076603daee94a167728110ef8086d0d5b37d
</span></span></code></pre></div><h2 id="初始化-worker-节点worker-执行">初始化 worker 节点（worker 执行）</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e">##过期怎么办</span>
</span></span><span style="display:flex;"><span>kubeadm token create --print-join-command
</span></span><span style="display:flex;"><span>kubeadm join --token y1eyw5.ylg568kvohfdsfco --discovery-token-ca-cert-hash sha256: 6c35e4f73f72afd89bf1c8c303ee55677d2cdb1342d67bb23c852aba2efc7c73
</span></span></code></pre></div><ul>
<li>5、验证集群</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e">#等一会，在master节点执行</span>
</span></span><span style="display:flex;"><span>kubectl get nodes
</span></span></code></pre></div><ul>
<li>6、设置 kube-proxy 的 ipvs 模式</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e">##修改kube-proxy默认的配置</span>
</span></span><span style="display:flex;"><span>kubectl edit cm kube-proxy -n kube-system
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 修改mode: &#34;ipvs&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##改完以后重启kube-proxy</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">### 查到所有的kube-proxy</span>
</span></span><span style="display:flex;"><span>kubectl get pod -n kube-system |grep kube-proxy
</span></span><span style="display:flex;"><span><span style="color:#75715e">### 删除之前的即可</span>
</span></span><span style="display:flex;"><span>kubectl delete pod 【用自己查出来的kube-proxy-dw5sf kube-proxy-hsrwp kube-proxy-vqv7n】  -n kube-system
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">###</span>
</span></span></code></pre></div>
                </div>
            <br />
        <div>
                
                <a href="https://www.jobcher.com/posts/work/shell1/" class="prev">前一页</a>
                
                
                <a href="https://www.jobcher.com/posts/work/maven/" class="next">后一页</a>
                
            </div>
        </article>
    </div>

    <nav class="footer-nav">
        <ul>
            
            <li><a href="/posts/about">关于我们</a></li>
            
            <li><a href="/posts">博文合集</a></li>
            
            <li><a href="/">网站首页</a></li>
            
        </ul>
    </nav>
    <footer class="footer">
    <span style="color: aliceblue;">© 2019-2023 by jobcher</span>
</footer>
</body>

</html>