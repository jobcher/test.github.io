<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<link media="all" rel="stylesheet" href="/css/style.css">

<script src="/js/style.js"></script>
    <title>kubernetes 从1.23.x 升级到 1.24.x</title>
</head>

<body>
    <div class="header-box">
    <img src="https://test.jobcher.com/images/logo.webp" id="logo" alt="logo" class="logo">
    <h1><a href="https://test.jobcher.com">打工人日志</a></h1>
</div>
<nav class="nav">
    <ul>
        
            <li>
                <a href="/">首页</a>
                
            </li>
        
            <li>
                <a href="/posts">文章</a>
                
            </li>
        
            <li>
                <a href="https://nav.jobcher.com/">导航</a>
                
            </li>
        
            <li>
                <a href="/posts/about">关于</a>
                
            </li>
        
    </ul>
</nav>
    <div id="post" class="post">
        <header>
            <h2 class="post-title">kubernetes 从1.23.x 升级到 1.24.x</h2>
            
        </header>
        <article class="article">
                <div class="single-content">
                    <h1 id="kubernetes-从123x-升级到-124x">kubernetes 从<code>1.23.x</code> 升级到 <code>1.24.x</code></h1>
<p>k8s 在<code>1.24.x</code>之后的版本放弃了和 docker 的兼容，使用 containerd 作为底层的容器，直接参照官方文档的资料进行更新就会报错。因为你没有安装 containerd，所以要安装 containerd 并配置才能正确的升级 k8s<br>
我用的是<code>CentOS7.9</code>的版本，因此以下操作都是在<code>CentOS</code>下操作。</p>
<h2 id="master-节点操作">Master 节点操作</h2>
<h3 id="1升级-kubeadm">1.升级 kubeadm</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>yum install -y kubeadm-1.24.2-0 --disableexcludes<span style="color:#f92672">=</span>kubernetes
</span></span><span style="display:flex;"><span>kubeadm version
</span></span><span style="display:flex;"><span>kubeadm upgrade plan
</span></span><span style="display:flex;"><span>sudo kubeadm upgrade apply v1.24.2
</span></span></code></pre></div><h3 id="2安装-containerd">2.安装 containerd</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>yum install containerd.io -y
</span></span><span style="display:flex;"><span>containerd config default &gt; /etc/containerd/config.toml
</span></span><span style="display:flex;"><span>vim /var/lib/kubelet/kubeadm-flags.env
</span></span></code></pre></div><p>修改 kubeadm-flags.env 变量：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>KUBELET_KUBEADM_ARGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--pod-infra-container-image=k8s.gcr.io/pause:3.6 --container-runtime=remote --container-runtime-endpoint=unix:///run/containerd/containerd.sock&#34;</span>
</span></span></code></pre></div><h3 id="3升级-kubelet">3.升级 kubelet</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>yum install -y kubelet-1.24.2-0 kubectl-1.24.2-0 --disableexcludes<span style="color:#f92672">=</span>kubernetes
</span></span><span style="display:flex;"><span>systemctl daemon-reload <span style="color:#f92672">&amp;&amp;</span> systemctl restart containerd  <span style="color:#f92672">&amp;&amp;</span> systemctl restart kubelet
</span></span></code></pre></div><p>查看状态：</p>
<blockquote>
<p>kubectl get nodes<br>
systemctl status kubelet</p>
</blockquote>
<h2 id="worker-节点操作">Worker 节点操作</h2>
<h3 id="1升级-kubeadm-1">1.升级 kubeadm</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>yum install -y kubeadm-1.24.2-0 --disableexcludes<span style="color:#f92672">=</span>kubernetes
</span></span><span style="display:flex;"><span>kubeadm version
</span></span><span style="display:flex;"><span>kubeadm upgrade plan
</span></span><span style="display:flex;"><span>sudo kubeadm upgrade node
</span></span></code></pre></div><h3 id="2安装-containerd-1">2.安装 containerd</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>yum install containerd.io -y
</span></span><span style="display:flex;"><span>containerd config default &gt; /etc/containerd/config.toml
</span></span><span style="display:flex;"><span>vim /var/lib/kubelet/kubeadm-flags.env
</span></span></code></pre></div><p>修改 kubeadm-flags.env 变量：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>KUBELET_KUBEADM_ARGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--pod-infra-container-image=k8s.gcr.io/pause:3.6 --container-runtime=remote --container-runtime-endpoint=unix:///run/containerd/containerd.sock&#34;</span>
</span></span></code></pre></div><h3 id="3升级-kubelet-1">3.升级 kubelet</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>yum install -y kubelet-1.24.2-0 kubectl-1.24.2-0 --disableexcludes<span style="color:#f92672">=</span>kubernetes
</span></span><span style="display:flex;"><span>systemctl daemon-reload <span style="color:#f92672">&amp;&amp;</span> systemctl restart containerd  <span style="color:#f92672">&amp;&amp;</span> systemctl restart kubelet
</span></span></code></pre></div><p>查看状态：</p>
<blockquote>
<p>systemctl status kubelet</p>
</blockquote>
<h3 id="4优化的维护节点">4.优化的维护节点</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># 设置为不可调度</span>
</span></span><span style="display:flex;"><span>kubectl cordon &lt;nodename&gt;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 优雅排出容器</span>
</span></span><span style="display:flex;"><span>kubectl drain &lt;nodename&gt; --ignore-daemonsets --delete-emptydir-data
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 确认维护完成之后，恢复正常</span>
</span></span><span style="display:flex;"><span>kubectl uncordon &lt;nodename&gt;
</span></span></code></pre></div>
                </div>
            <br />
        <div>
                
                <a href="https://test.jobcher.com/posts/monitoring/logstash/" class="prev">前一页</a>
                
                
                <a href="https://test.jobcher.com/posts/kubernetes/k8s8/" class="next">后一页</a>
                
            </div>
        </article>
    </div>

    <nav class="footer-nav">
        <ul>
            
            <li><a href="/posts/about">关于我们</a></li>
            
            <li><a href="/posts">博文合集</a></li>
            
            <li><a href="/">网站首页</a></li>
            
        </ul>
    </nav>
    <footer class="footer">
    <span style="color: aliceblue;">© 2019-2023 by jobcher</span>
</footer>
</body>

</html>