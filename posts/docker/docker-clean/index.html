<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<link media="all" rel="stylesheet" href="/css/style.css">

<script src="/js/style.js"></script>



    <title>清理Docker的container，image与volume - 打工人日志</title>
</head>

<body>
    <div class="header-box">
    <img src="https://www.jobcher.com/images/logo.webp" id="logo" alt="logo" class="logo">
    <h1><a href="https://www.jobcher.com">打工人日志</a></h1>
</div>
<nav class="nav">
    <ul>
        
            <li>
                <a href="/">首页</a>
                
            </li>
        
            <li>
                <a href="/posts">文章</a>
                
            </li>
        
            <li>
                <a href="https://nav.jobcher.com/">导航</a>
                
            </li>
        
            <li>
                <a href="/posts/about">关于</a>
                
            </li>
        
    </ul>
</nav>
    <div id="post" class="post">
        <header>
            <h2 class="post-title">清理Docker的container，image与volume</h2>
            
        </header>
        <article class="article">
                <div class="single-content">
                    <h1 id="清理-docker-的-containerimage-与-volume">清理 Docker 的 container，image 与 volume</h1>
<p>Docker 的镜像（image）、容器（container）、数据卷（volume）， 都是由 daemon 托管的。 因此，在需要清理时，也需要使用其自带的手段。</p>
<h2 id="清理技巧">清理技巧</h2>
<p>清理所有停止运行的容器：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker container prune
</span></span><span style="display:flex;"><span><span style="color:#75715e"># or</span>
</span></span><span style="display:flex;"><span>docker rm <span style="color:#66d9ef">$(</span>docker ps -aq<span style="color:#66d9ef">)</span>
</span></span></code></pre></div><p>清理所有悬挂<code>（&lt;none&gt;）</code>镜像：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker image prune
</span></span><span style="display:flex;"><span><span style="color:#75715e"># or</span>
</span></span><span style="display:flex;"><span>docker rmi <span style="color:#66d9ef">$(</span>docker images -qf <span style="color:#e6db74">&#34;dangling=true&#34;</span><span style="color:#66d9ef">)</span>
</span></span></code></pre></div><p>清理所有无用数据卷：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker volume prune
</span></span></code></pre></div><p>由于<code>prune</code>操作是批量删除类的危险操作，所以会有一次确认。 如果不想输入<code>y&lt;CR&gt;</code>来确认，可以添加<code>-f</code>操作。慎用！</p>
<h2 id="清理停止的容器">清理停止的容器</h2>
<p>docker rm -lv CONTAINER
<code>-l</code>是清理 link，<code>v</code>是清理 volume。 这里的 CONTAINER 是容器的 name 或 ID，可以是一个或多个。</p>
<p>参数列表：</p>
<table>
<thead>
<tr>
<th style="text-align:left">Name shorthand</th>
<th style="text-align:left">Default</th>
<th style="text-align:left">Description</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">–force,-f</td>
<td style="text-align:left">false</td>
<td style="text-align:left">Force the removal of a running container (uses SIGKILL)</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">–link, -l</td>
<td style="text-align:left">false</td>
<td style="text-align:left">Remove the specified link</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">–volumes, -v</td>
<td style="text-align:left"></td>
<td style="text-align:left">false</td>
<td>Remove the volumes associated with the container</td>
</tr>
</tbody>
</table>
<h2 id="清理所有停止的容器">清理所有停止的容器</h2>
<p>通过<code>docker ps</code>可以查询当前运行的容器信息。 而通过<code>docker ps -a</code>，可以查询所有的容器信息，包括已停止的。</p>
<p>在需要清理所有已停止的容器时，通常利用 shell 的特性，组合一下就好。</p>
<p>docker rm $(docker ps -aq)
其中，<code>ps的-q</code>，是只输出容器 ID，方便作为参数让<code>rm</code>使用。 假如给<code>rm</code>指定<code>-f</code>，则可以清理所有容器，包括正在运行的。</p>
<p>这条组合命令，等价于另一条命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker container prune
</span></span></code></pre></div><p><code>container</code>子命令，下面包含了所有和容器相关的子命令。 包括<code>docker ps</code>，等价于<code>docker container ps</code>或<code>docker container ls</code>。 其余还有<code>start、stop、kill、cp</code>等，一级子命令相当于二级子命令在外面的 alias。 而<code>prune</code>则是特别提供的清理命令，这在其它的管理命令里还可以看到，比如<code>image、volume</code>。</p>
<h2 id="按需批量清理容器">按需批量清理容器</h2>
<p>清除所有已停止的容器，是比较常用的清理。 但有时会需要做一些特殊过滤。</p>
<p>这时就需要使用<code>docker ps --filter</code>。</p>
<p>比如，显示所有返回值为 0，即正常退出的容器：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker ps -a --filter <span style="color:#e6db74">&#39;exited=0&#39;</span>
</span></span></code></pre></div><p>同理，可以得到其它非正常退出的容器。</p>
<p>目前支持的过滤器有：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>id (container’s id)
</span></span><span style="display:flex;"><span>label (label=&lt;key&gt; or label=&lt;key&gt;=&lt;value&gt;)
</span></span><span style="display:flex;"><span>name (container’s name)
</span></span><span style="display:flex;"><span>exited (int - the code of exited containers. Only useful with –all)
</span></span><span style="display:flex;"><span>status (created|restarting|running|removing|paused|exited|dead)
</span></span><span style="display:flex;"><span>ancestor (&lt;image-name&gt;[:&lt;tag&gt;], &lt;image id&gt; or &lt;image@digest&gt;) - filters containers that were created from the given image or a descendant.
</span></span><span style="display:flex;"><span>before (container’s id or name) - filters containers created before given id or name
</span></span><span style="display:flex;"><span>since (container’s id or name) - filters containers created since given id or name
</span></span><span style="display:flex;"><span>isolation (default|process|hyperv) (Windows daemon only)
</span></span><span style="display:flex;"><span>volume (volume name or mount point) - filters containers that mount volumes.
</span></span><span style="display:flex;"><span>network (network id or name) - filters containers connected to the provided network
</span></span><span style="display:flex;"><span>health (starting|healthy|unhealthy|none) - filters containers based on healthcheck status
</span></span></code></pre></div><h2 id="清理失败">清理失败</h2>
<p>如果在清理容器时发生失败，通过重启 Docker 的 Daemon，应该都能解决问题。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># systemd</span>
</span></span><span style="display:flex;"><span>sudo systemctl restart docker.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># initd</span>
</span></span><span style="display:flex;"><span>sudo service docker restart
</span></span></code></pre></div><h2 id="清理镜像">清理镜像</h2>
<p>与清理容器的<code>ps、rm</code>类似，清理镜像也有<code>images、rmi</code>两个子命令。 <code>images</code>用来查看，<code>rmi</code>用来删除。</p>
<p>清理镜像前，应该确保该镜像的容器，已经被清除。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker rmi IMAGE
</span></span></code></pre></div><p>其中，IMAGE 可以是 name 或 ID。 如果是 name，不加 TAG 可以删除所有 TAG。</p>
<p>另外，这两个命令也都属于 alias。 <code>docker images</code>等价<code>于docker image ls</code>，而<code>docker rmi</code>等价于<code>docker image rm</code>。</p>
<p>按需批量清理镜像 ¶
与<code>ps</code>类似，<code>images</code>也支持<code>--filter</code>参数。</p>
<p>与清理相关，最常用的，当属<code>&lt;none&gt;</code>了。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker images --filter <span style="color:#e6db74">&#34;dangling=true&#34;</span>
</span></span></code></pre></div><p>这条命令，可以列出所有悬挂（dangling）的镜像，也就是显示为<!-- raw HTML omitted -->的那些。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker rmi <span style="color:#66d9ef">$(</span>docker images -qf <span style="color:#e6db74">&#34;dangling=true&#34;</span><span style="color:#66d9ef">)</span>
</span></span></code></pre></div><p>这条组合命令，如果不写入 Bash 的 alias，几乎无法使用。 不过还有一条等价命令，非常容易使用。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker image prune
</span></span></code></pre></div><p><code>prune</code>和<code>images</code>类似，也同样支持&ndash;filter 参数。 其它的<code>filter</code>有：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>dangling (boolean - true or false)
</span></span><span style="display:flex;"><span>label (label=&lt;key&gt; or label=&lt;key&gt;=&lt;value&gt;)
</span></span><span style="display:flex;"><span>before (&lt;image-name&gt;[:&lt;tag&gt;], &lt;image id&gt; or &lt;image@digest&gt;) - filter images created before given id or references
</span></span><span style="display:flex;"><span>since (&lt;image-name&gt;[:&lt;tag&gt;], &lt;image id&gt; or &lt;image@digest&gt;) - filter images created since given id or references
</span></span><span style="display:flex;"><span>reference (pattern of an image reference) - filter images whose reference matches the specified pattern
</span></span></code></pre></div><h2 id="清理所有无用镜像">清理所有无用镜像</h2>
<p>这招要慎用，否则需要重新下载。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker image prune -a
</span></span></code></pre></div><h2 id="清理数据卷">清理数据卷</h2>
<p>数据卷不如容器或镜像那样显眼，但占的硬盘却可大可小。</p>
<p>数据卷的相关命令，都在<code>docker volume</code>中了。</p>
<p>一般用<code>docker volume ls</code>来查看，用<code>docker volume rm VOLUME</code>来删除一个或多个。</p>
<p>不过，绝大多数情况下，不需要执行这两个命令的组合。 直接执行<code>docker volume prune</code>就好，即可删除所有无用卷。</p>
<p>注意：这是一个危险操作！甚至可以说，这是本文中最危险的操作！ 一般真正有价值的运行数据，都在数据卷中。 （当然也可能挂载到了容器外的文件系统里，那就没关系。） 如果在关键服务停止期间，执行这个操作，很可能会丢失所有数据！</p>
<h2 id="从文件系统删除">从文件系统删除</h2>
<p>除配置文件以为，Docker 的内容相关文件，基本都放在<code>/var/lib/docker/</code>目录下。</p>
<p>该目录下有下列子目录，基本可以猜测出用途：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>aufs
</span></span><span style="display:flex;"><span>containers
</span></span><span style="display:flex;"><span>image
</span></span><span style="display:flex;"><span>network
</span></span><span style="display:flex;"><span>plugins
</span></span><span style="display:flex;"><span>swarm
</span></span><span style="display:flex;"><span>tmp
</span></span><span style="display:flex;"><span>trust
</span></span><span style="display:flex;"><span>volumes
</span></span></code></pre></div><p>一般不推荐直接操作这些目录，除非一些极特殊情况。 操作不当，后果难料，需要慎重。</p>

                </div>
            <br />
        <div>
                
                <a href="https://www.jobcher.com/posts/diary/wxyun/" class="prev">前一页</a>
                
                
                <a href="https://www.jobcher.com/posts/git/jenkins/" class="next">后一页</a>
                
            </div>
        </article>
    </div>

    <nav class="footer-nav">
        <ul>
            
            <li><a href="/posts/about">关于我们</a></li>
            
            <li><a href="/posts">博文合集</a></li>
            
            <li><a href="/">网站首页</a></li>
            
        </ul>
    </nav>
    <footer class="footer">
    <span style="color: aliceblue;">© 2019-2023 by jobcher</span>
</footer>
</body>

</html>