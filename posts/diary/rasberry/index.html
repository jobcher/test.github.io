<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<link media="all" rel="stylesheet" href="../../../css/style.css">

<script src="../../../js/style.js"></script>



    <title>树莓派搭建k3s - 打工人日志</title>
</head>

<body>
    <div class="header-box">
    <img src="https://test.jobcher.com/images/logo.webp" id="logo" alt="logo" class="logo">
    <h1><a href="https://test.jobcher.com">打工人日志</a></h1>
</div>
<nav class="nav">
    <ul>
        
            <li>
                <a href="../../../">首页</a>
                
            </li>
        
            <li>
                <a href="../../../posts">文章</a>
                
            </li>
        
            <li>
                <a href="https://nav.jobcher.com/">导航</a>
                
            </li>
        
            <li>
                <a href="../../../posts/about">关于</a>
                
            </li>
        
    </ul>
</nav>
    <div id="post" class="post">
        <header>
            <h2 class="post-title">树莓派搭建k3s</h2>
            
        </header>
        <article class="article">
                <div class="single-content">
                    <h1 id="树莓派安装-k3s">树莓派安装 k3s</h1>
<h2 id="1安装-k3s">1.安装 k3s</h2>
<h3 id="控制节点">控制节点</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>    curl -sfL https://get.k3s.io | sh -
</span></span><span style="display:flex;"><span>    cat /var/lib/rancher/k3s/server/node-token
</span></span></code></pre></div><h3 id="工作节点">工作节点</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>    curl -sfL https://get.k3s.io | K3S_URL<span style="color:#f92672">=</span>https://myserver:6443 K3S_TOKEN<span style="color:#f92672">=</span>mynodetoken sh -
</span></span></code></pre></div><p>树莓派特别要注意一个坑，就是关于内存的问题这个之后再讲</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>    k3s kubectl get nodes
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#显示正确的节点表示完成</span>
</span></span></code></pre></div><h3 id="卸载-k3s">卸载 k3s</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>    <span style="color:#75715e">#server 节点</span>
</span></span><span style="display:flex;"><span>    /usr/local/bin/k3s-uninstall.sh
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#agent 节点</span>
</span></span><span style="display:flex;"><span>    /usr/local/bin/k3s-agent-uninstall.sh
</span></span></code></pre></div><h2 id="2安装-dashboard-k3s-面板">2.安装 dashboard k3s 面板</h2>
<h3 id="部署-kubernetes-仪表盘">部署 Kubernetes 仪表盘</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>    GITHUB_URL<span style="color:#f92672">=</span>https://github.com/kubernetes/dashboard/releases
</span></span><span style="display:flex;"><span>    VERSION_KUBE_DASHBOARD<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>curl -w <span style="color:#e6db74">&#39;%{url_effective}&#39;</span> -I -L -s -S <span style="color:#e6db74">${</span>GITHUB_URL<span style="color:#e6db74">}</span>/latest -o /dev/null | sed -e <span style="color:#e6db74">&#39;s|.*/||&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>    sudo k3s kubectl create -f https://raw.githubusercontent.com/kubernetes/dashboard/<span style="color:#e6db74">${</span>VERSION_KUBE_DASHBOARD<span style="color:#e6db74">}</span>/aio/deploy/recommended.yaml
</span></span></code></pre></div><h3 id="仪表盘-rbac-配置">仪表盘 RBAC 配置</h3>
<p>创建以下资源清单文件：</p>
<p>dashboard.admin-user.yml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">admin-user</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kubernetes-dashboard</span>
</span></span></code></pre></div><p>dashboard.admin-user-role.yml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">admin-user</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cluster-admin</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">admin-user</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kubernetes-dashboard</span>
</span></span></code></pre></div><p>部署 admin-user 配置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>    sudo k3s kubectl create -f dashboard.admin-user.yml -f dashboard.admin-user-role.yml
</span></span></code></pre></div><p>获得 Bearer Token</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>    sudo k3s kubectl -n kubernetes-dashboard describe secret admin-user-token | grep <span style="color:#e6db74">&#39;^token&#39;</span>
</span></span></code></pre></div><p>现在可以通过以下网址访问仪表盘：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>    sudo k3s kubectl proxy
</span></span></code></pre></div><p>http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/</p>
<h3 id="连接-lens">连接 lens</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>    cat /etc/rancher/k3s/k3s.yaml
</span></span><span style="display:flex;"><span>    更改本地host
</span></span><span style="display:flex;"><span>    穿透服务器IP    local
</span></span></code></pre></div><h2 id="3安装-kubeprometheus-监控">3.安装 kube—prometheus 监控</h2>
<h3 id="一键安装">一键安装</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>    wget https://github.com/prometheus-operator/kube-prometheus/archive/refs/tags/v0.9.0.tar.gz
</span></span><span style="display:flex;"><span>    tar -zxvf v0.9.0.tar.gz
</span></span><span style="display:flex;"><span>    cd kube-prometheus-0.9.0/manifests
</span></span><span style="display:flex;"><span>    k3s kubectl apply -f setup/
</span></span><span style="display:flex;"><span>    k3s kubectl get pod -n monitoring
</span></span><span style="display:flex;"><span>    k3s kubectl apply -f .
</span></span></code></pre></div><h3 id="一键卸载">一键卸载</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>    cd kube-prometheus/manifests
</span></span><span style="display:flex;"><span>    k3s kubectl delete -f .
</span></span><span style="display:flex;"><span>    k3s kubectl delete -f setup/
</span></span></code></pre></div><h2 id="4安装-nfs-外部驱动挂载-storageclass">4.安装 nfs 外部驱动挂载 storageclass</h2>
<h2 id="5创建有状态-podsmysql">5.创建有状态 pods（mysql）</h2>

                </div>
            <br />
        <div>
                
                <a href="https://test.jobcher.com/posts/diary/nps/" class="prev">前一页</a>
                
                
                <a href="https://test.jobcher.com/posts/mac/brew/" class="next">后一页</a>
                
            </div>
        </article>
    </div>

    <nav class="footer-nav">
        <ul>
            
            <li><a href="../../../posts/about">关于我们</a></li>
            
            <li><a href="../../../posts">博文合集</a></li>
            
            <li><a href="../../../">网站首页</a></li>
            
        </ul>
    </nav>
    <footer class="footer">
    <span style="color: aliceblue;">© 2019-2023 by jobcher</span>
</footer>
</body>

</html>