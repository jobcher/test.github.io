<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<link media="all" rel="stylesheet" href="/css/style.css">

<script src="/js/style.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>

    <title>github 国内代理访问下载</title>
</head>

<body>
    <div class="header-box">
    <img src="https://test.jobcher.com/images/logo.webp" id="logo" alt="logo" class="logo">
    <h1><a href="https://test.jobcher.com">打工人日志</a></h1>
</div>
<nav class="nav">
    <ul>
        
            <li>
                <a href="/">首页</a>
                
            </li>
        
            <li>
                <a href="/posts">文章</a>
                
            </li>
        
            <li>
                <a href="https://nav.jobcher.com/">导航</a>
                
            </li>
        
            <li>
                <a href="/posts/about">关于</a>
                
            </li>
        
    </ul>
</nav>
    <div id="post" class="post">
        <header>
            <h2 class="post-title">github 国内代理访问下载</h2>
            
                <img src="/images/github.png" alt="github 国内代理访问下载" class="featured-image">
            
        </header>
        <article class="article">
                <div class="single-content">
                    <h2 id="演示代理">演示代理</h2>
<ol>
<li>前缀</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>https://github.jobcher.com/gh/
</span></span></code></pre></div><ol start="2">
<li>下载仓库</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>git clone https://github.jobcher.com/gh/&lt;你要下载的GitHub地址&gt;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#例子</span>
</span></span><span style="display:flex;"><span>git clone https://github.jobcher.com/gh/https://github.com/jobcher/blog.git
</span></span></code></pre></div><h2 id="部署">部署</h2>
<p>复制js到cloudflare worker</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#e6db74">&#39;use strict&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * static files (404.html, sw.js, conf.js)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">ASSET_URL</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;https://jobcher.github.io/&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 前缀，如果自定义路由为example.com/gh/*，将PREFIX改为 &#39;/gh/&#39;，注意，少一个杠都会错！
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">PREFIX</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/gh/&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 分支文件使用jsDelivr镜像的开关，0为关闭，默认关闭
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">Config</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">jsdelivr</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">whiteList</span> <span style="color:#f92672">=</span> [] <span style="color:#75715e">// 白名单，路径里面有包含字符的才会通过，e.g. [&#39;/username/&#39;]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/** @type {RequestInit} */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">PREFLIGHT_INIT</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">204</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">headers</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Headers</span>({
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;access-control-allow-origin&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;*&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;access-control-allow-methods&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;GET,POST,PUT,PATCH,TRACE,DELETE,HEAD,OPTIONS&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;access-control-max-age&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;1728000&#39;</span>,
</span></span><span style="display:flex;"><span>    }),
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">exp1</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/^(?:https?:\/\/)?github\.com\/.+?\/.+?\/(?:releases|archive)\/.*$/i</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">exp2</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/^(?:https?:\/\/)?github\.com\/.+?\/.+?\/(?:blob|raw)\/.*$/i</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">exp3</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/^(?:https?:\/\/)?github\.com\/.+?\/.+?\/(?:info|git-).*$/i</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">exp4</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/^(?:https?:\/\/)?raw\.(?:githubusercontent|github)\.com\/.+?\/.+?\/.+?\/.+$/i</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">exp5</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/^(?:https?:\/\/)?gist\.(?:githubusercontent|github)\.com\/.+?\/.+?\/.+$/i</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">exp6</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/^(?:https?:\/\/)?github\.com\/.+?\/.+?\/tags.*$/i</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param {any} body
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param {number} status
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param {Object&lt;string, string&gt;} headers
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">makeRes</span>(<span style="color:#a6e22e">body</span>, <span style="color:#a6e22e">status</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">headers</span> <span style="color:#f92672">=</span> {}) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">headers</span>[<span style="color:#e6db74">&#39;access-control-allow-origin&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;*&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Response</span>(<span style="color:#a6e22e">body</span>, {<span style="color:#a6e22e">status</span>, <span style="color:#a6e22e">headers</span>})
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param {string} urlStr
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">newUrl</span>(<span style="color:#a6e22e">urlStr</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">URL</span>(<span style="color:#a6e22e">urlStr</span>)
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">err</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#39;fetch&#39;</span>, <span style="color:#a6e22e">e</span> =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">ret</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fetchHandler</span>(<span style="color:#a6e22e">e</span>)
</span></span><span style="display:flex;"><span>        .<span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">err</span> =&gt; <span style="color:#a6e22e">makeRes</span>(<span style="color:#e6db74">&#39;cfworker error:\n&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">stack</span>, <span style="color:#ae81ff">502</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">respondWith</span>(<span style="color:#a6e22e">ret</span>)
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">checkUrl</span>(<span style="color:#a6e22e">u</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#66d9ef">of</span> [<span style="color:#a6e22e">exp1</span>, <span style="color:#a6e22e">exp2</span>, <span style="color:#a6e22e">exp3</span>, <span style="color:#a6e22e">exp4</span>, <span style="color:#a6e22e">exp5</span>, <span style="color:#a6e22e">exp6</span>]) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">search</span>(<span style="color:#a6e22e">i</span>) <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param {FetchEvent} e
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">fetchHandler</span>(<span style="color:#a6e22e">e</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">req</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">request</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">urlStr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">url</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">urlObj</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">URL</span>(<span style="color:#a6e22e">urlStr</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">path</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">urlObj</span>.<span style="color:#a6e22e">searchParams</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;q&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">path</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Response</span>.<span style="color:#a6e22e">redirect</span>(<span style="color:#e6db74">&#39;https://&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">urlObj</span>.<span style="color:#a6e22e">host</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">PREFIX</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">path</span>, <span style="color:#ae81ff">301</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// cfworker 会把路径中的 `//` 合并成 `/`
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">path</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">urlObj</span>.<span style="color:#a6e22e">href</span>.<span style="color:#a6e22e">substr</span>(<span style="color:#a6e22e">urlObj</span>.<span style="color:#a6e22e">origin</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">PREFIX</span>.<span style="color:#a6e22e">length</span>).<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">/^https?:\/+/</span>, <span style="color:#e6db74">&#39;https://&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">search</span>(<span style="color:#a6e22e">exp1</span>) <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">search</span>(<span style="color:#a6e22e">exp5</span>) <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">search</span>(<span style="color:#a6e22e">exp6</span>) <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">search</span>(<span style="color:#a6e22e">exp3</span>) <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">search</span>(<span style="color:#a6e22e">exp4</span>) <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">httpHandler</span>(<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">path</span>)
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">search</span>(<span style="color:#a6e22e">exp2</span>) <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">Config</span>.<span style="color:#a6e22e">jsdelivr</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">newUrl</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">&#39;/blob/&#39;</span>, <span style="color:#e6db74">&#39;@&#39;</span>).<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">/^(?:https?:\/\/)?github\.com/</span>, <span style="color:#e6db74">&#39;https://cdn.jsdelivr.net/gh&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Response</span>.<span style="color:#a6e22e">redirect</span>(<span style="color:#a6e22e">newUrl</span>, <span style="color:#ae81ff">302</span>)
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">path</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">&#39;/blob/&#39;</span>, <span style="color:#e6db74">&#39;/raw/&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">httpHandler</span>(<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">path</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">search</span>(<span style="color:#a6e22e">exp4</span>) <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">newUrl</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">/(?&lt;=com\/.+?\/.+?)\/(.+?\/)/</span>, <span style="color:#e6db74">&#39;@$1&#39;</span>).<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">/^(?:https?:\/\/)?raw\.(?:githubusercontent|github)\.com/</span>, <span style="color:#e6db74">&#39;https://cdn.jsdelivr.net/gh&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Response</span>.<span style="color:#a6e22e">redirect</span>(<span style="color:#a6e22e">newUrl</span>, <span style="color:#ae81ff">302</span>)
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fetch</span>(<span style="color:#a6e22e">ASSET_URL</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">path</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param {Request} req
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param {string} pathname
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">httpHandler</span>(<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">pathname</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">reqHdrRaw</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">headers</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// preflight
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">method</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;OPTIONS&#39;</span> <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">reqHdrRaw</span>.<span style="color:#a6e22e">has</span>(<span style="color:#e6db74">&#39;access-control-request-headers&#39;</span>)
</span></span><span style="display:flex;"><span>    ) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Response</span>(<span style="color:#66d9ef">null</span>, <span style="color:#a6e22e">PREFLIGHT_INIT</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">reqHdrNew</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Headers</span>(<span style="color:#a6e22e">reqHdrRaw</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">urlStr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">pathname</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">flag</span> <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>Boolean(<span style="color:#a6e22e">whiteList</span>.<span style="color:#a6e22e">length</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">whiteList</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">urlStr</span>.<span style="color:#a6e22e">includes</span>(<span style="color:#a6e22e">i</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">flag</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">flag</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Response</span>(<span style="color:#e6db74">&#34;blocked&#34;</span>, {<span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">403</span>})
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">urlStr</span>.<span style="color:#a6e22e">startsWith</span>(<span style="color:#e6db74">&#39;github&#39;</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">urlStr</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;https://&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">urlStr</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">urlObj</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">newUrl</span>(<span style="color:#a6e22e">urlStr</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/** @type {RequestInit} */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">reqInit</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">method</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">method</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">headers</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">reqHdrNew</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">redirect</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;manual&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">body</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">body</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">proxy</span>(<span style="color:#a6e22e">urlObj</span>, <span style="color:#a6e22e">reqInit</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param {URL} urlObj
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param {RequestInit} reqInit
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">proxy</span>(<span style="color:#a6e22e">urlObj</span>, <span style="color:#a6e22e">reqInit</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">fetch</span>(<span style="color:#a6e22e">urlObj</span>.<span style="color:#a6e22e">href</span>, <span style="color:#a6e22e">reqInit</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">resHdrOld</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">headers</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">resHdrNew</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Headers</span>(<span style="color:#a6e22e">resHdrOld</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">status</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">status</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">resHdrNew</span>.<span style="color:#a6e22e">has</span>(<span style="color:#e6db74">&#39;location&#39;</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">_location</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">resHdrNew</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;location&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">checkUrl</span>(<span style="color:#a6e22e">_location</span>))
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">resHdrNew</span>.<span style="color:#a6e22e">set</span>(<span style="color:#e6db74">&#39;location&#39;</span>, <span style="color:#a6e22e">PREFIX</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">_location</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">reqInit</span>.<span style="color:#a6e22e">redirect</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;follow&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">proxy</span>(<span style="color:#a6e22e">newUrl</span>(<span style="color:#a6e22e">_location</span>), <span style="color:#a6e22e">reqInit</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">resHdrNew</span>.<span style="color:#a6e22e">set</span>(<span style="color:#e6db74">&#39;access-control-expose-headers&#39;</span>, <span style="color:#e6db74">&#39;*&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">resHdrNew</span>.<span style="color:#a6e22e">set</span>(<span style="color:#e6db74">&#39;access-control-allow-origin&#39;</span>, <span style="color:#e6db74">&#39;*&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">resHdrNew</span>.<span style="color:#66d9ef">delete</span>(<span style="color:#e6db74">&#39;content-security-policy&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">resHdrNew</span>.<span style="color:#66d9ef">delete</span>(<span style="color:#e6db74">&#39;content-security-policy-report-only&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">resHdrNew</span>.<span style="color:#66d9ef">delete</span>(<span style="color:#e6db74">&#39;clear-site-data&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Response</span>(<span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">body</span>, {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">status</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">headers</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">resHdrNew</span>,
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
                </div>
            <br />
        <div>
                
                <a href="https://test.jobcher.com/posts/web/nginx06/" class="prev">前一页</a>
                
                
                <a href="https://test.jobcher.com/posts/work/scrapyredis/" class="next">后一页</a>
                
            </div>
        </article>
    </div>

    <nav class="footer-nav">
        <ul>
            
            <li><a href="/posts/about">关于我们</a></li>
            
            <li><a href="/posts">博文合集</a></li>
            
            <li><a href="/">网站首页</a></li>
            
        </ul>
    </nav>
    <footer class="footer">
    <span style="color: aliceblue;">© 2019-2023 by jobcher</span>
</footer>
</body>

</html>