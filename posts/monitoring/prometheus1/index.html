<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<link media="all" rel="stylesheet" href="/css/style.css">

<script src="/js/style.js"></script>



    <title>prometheus grafana alertmanager 安装配置</title>
</head>

<body>
    <div class="header-box">
    <img src="https://www.jobcher.com/images/logo.webp" id="logo" alt="logo" class="logo">
    <h1><a href="https://www.jobcher.com">打工人日志</a></h1>
</div>
<nav class="nav">
    <ul>
        
            <li>
                <a href="/">首页</a>
                
            </li>
        
            <li>
                <a href="/posts">文章</a>
                
            </li>
        
            <li>
                <a href="https://nav.jobcher.com/">导航</a>
                
            </li>
        
            <li>
                <a href="/posts/about">关于</a>
                
            </li>
        
    </ul>
</nav>
    <div id="post" class="post">
        <header>
            <h2 class="post-title">prometheus grafana alertmanager 安装配置</h2>
            
        </header>
        <article class="article">
                <div class="single-content">
                    <h1 id="prometheusgrafanaalertmanager-安装配置">prometheus+grafana+alertmanager 安装配置</h1>
<p>服务器监控告警系统搭建，通过 exporter 获取节点信息到 prometheus。prometheus 配置规则，使 garfana 和 alertmanager 能够接受到数据，分别展示数据和发送告警</p>
<h2 id="参数">参数</h2>
<p>VM :192.168.99.78</p>
<table>
<thead>
<tr>
<th style="text-align:left">端口</th>
<th style="text-align:left">服务</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">9100</td>
<td style="text-align:left">node_exporter</td>
</tr>
<tr>
<td style="text-align:left">3000</td>
<td style="text-align:left">grafana</td>
</tr>
<tr>
<td style="text-align:left">9090</td>
<td style="text-align:left">prometheus</td>
</tr>
<tr>
<td style="text-align:left">9115</td>
<td style="text-align:left">blackbox_exporter</td>
</tr>
</tbody>
</table>
<h2 id="安装">安装</h2>
<h3 id="grafa-安装">grafa 安装</h3>
<ol>
<li>docker 安装</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker run -d -p 3000:3000 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--name<span style="color:#f92672">=</span>grafana <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-v grafana-storage:/var/lib/grafana <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>grafana/grafana:8.3.3
</span></span></code></pre></div><h3 id="prometheus-安装">prometheus 安装</h3>
<ol>
<li>下载</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>wget https://github.com/prometheus/prometheus/releases/download/v2.32.1/prometheus-2.32.1.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>tar -zxvf prometheus-2.32.1.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>cd prometheus-2.32.1.linux-amd64
</span></span><span style="display:flex;"><span>mkdir -p file_sd
</span></span><span style="display:flex;"><span>mkdir -p rules
</span></span></code></pre></div><ol start="2">
<li>运行 prometheus</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>killall prometheus
</span></span><span style="display:flex;"><span>nohup ./prometheus --config.file<span style="color:#f92672">=</span>prometheus.yml &amp;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看运行状况</span>
</span></span><span style="display:flex;"><span>tail -f nohup.out
</span></span></code></pre></div><h3 id="node_exporter-安装">node_exporter 安装</h3>
<ol>
<li>docker-compose 安装</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">node-exporter</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">prom/node-exporter:v1.3.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">node-exporter</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;9100:9100&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker-compose up -d
</span></span></code></pre></div><ol start="2">
<li>二进制安装</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>wget https://github.com/prometheus/node_exporter/releases/download/v1.3.1/node_exporter-1.3.1.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>tar -zxvf node_exporter-1.3.1.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>cd node_exporter-1.3.1.linux-amd64
</span></span><span style="display:flex;"><span>nohup ./node_exporter &amp;
</span></span></code></pre></div><h3 id="blackbox_exporter">blackbox_exporter</h3>
<ol>
<li>二进制安装</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>wget https://github.com/prometheus/blackbox_exporter/releases/download/v0.19.0/blackbox_exporter-0.19.0.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>tar -zxvf blackbox_exporter-0.19.0.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>cd blackbox_exporter-0.19.0.linux-amd64
</span></span><span style="display:flex;"><span>nohup ./blackbox_exporter &amp;
</span></span></code></pre></div><h3 id="alertmanager">Alertmanager</h3>
<ol>
<li>二进制安装</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>wget https://github.com/prometheus/alertmanager/releases/download/v0.23.0/alertmanager-0.23.0.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>tar -zxvf alertmanager-0.23.0.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>cd alertmanager-0.23.0.linux-amd64
</span></span><span style="display:flex;"><span>nohup ./alertmanager &amp;
</span></span></code></pre></div><ol start="2">
<li>docker-compose 安装</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">alertmanager</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#e6db74">&#34;prom/alertmanager:v0.22.2&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;/etc/localtime:/etc/localtime&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;./alertmanager.yml:/etc/alertmanager/alertmanager.yml&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;9093:9093&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restart</span>: <span style="color:#e6db74">&#34;always&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#e6db74">&#34;alertmanager&#34;</span>
</span></span></code></pre></div><h2 id="prometheusyml-配置">prometheus.yml 配置</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_interval</span>: <span style="color:#ae81ff">15s</span> <span style="color:#75715e"># By default, scrape targets every 15 seconds.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Attach these labels to any time series or alerts when communicating with</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># external systems (federation, remote storage, Alertmanager).</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">external_labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">monitor</span>: <span style="color:#e6db74">&#34;codelab-monitor&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Alertmanager configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># alerting:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   alertmanagers:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   - static_configs:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     - targets:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#       - 192.168.99.78:9093</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Load rules once and periodically evaluate them according to the global &#39;evaluation_interval&#39;.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># rule_files:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   - &#34;./rules/blackbox.yaml&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   - &#34;./rules/node-exporter.yaml&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># A scrape configuration containing exactly one endpoint to scrape:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Here it&#39;s Prometheus itself.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">scrape_configs</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#34;prometheus&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Override the global default and scrape targets from this job every 5 seconds.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scrape_interval</span>: <span style="color:#ae81ff">5s</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">targets</span>: [<span style="color:#e6db74">&#34;localhost:9090&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#34;node-exporter&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">file_sd_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">files</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#e6db74">&#34;./file_sd/node-exporter.yaml&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">refresh_interval</span>: <span style="color:#ae81ff">5s</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#34;blackbox&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metrics_path</span>: <span style="color:#ae81ff">/probe</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scrape_interval</span>: <span style="color:#ae81ff">30s</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scrape_timeout</span>: <span style="color:#ae81ff">30s</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">params</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">module</span>: [<span style="color:#ae81ff">http_2xx]</span> <span style="color:#75715e"># Look for a HTTP 200 response.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">file_sd_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">files</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#e6db74">&#34;./file_sd/blackbox.yaml&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">refresh_interval</span>: <span style="color:#ae81ff">5s</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__address__]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__param_target</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__param_target]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">instance</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">replacement</span>: <span style="color:#ae81ff">192.168.99.78</span>:<span style="color:#ae81ff">9115</span>
</span></span></code></pre></div><h3 id="node-exporteryaml">node-exporter.yaml</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">targets</span>: [<span style="color:#e6db74">&#34;192.168.99.78:9100&#34;</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">instance</span>: <span style="color:#ae81ff">&lt;实例名称&gt;</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">targets</span>: [<span style="color:#e6db74">&#34;&lt;IP&gt;:9100&#34;</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">instance</span>: <span style="color:#ae81ff">实例名称</span>
</span></span></code></pre></div><h3 id="blackboxyaml">blackbox.yaml</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">targets</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">https://www.jobcher.com</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">https://&lt;域名&gt;</span>
</span></span></code></pre></div>
                </div>
            <br />
        <div>
                
                <a href="https://www.jobcher.com/posts/kubernetes/harbor/" class="prev">前一页</a>
                
                
                <a href="https://www.jobcher.com/posts/monitoring/prometheus/" class="next">后一页</a>
                
            </div>
        </article>
    </div>

    <nav class="footer-nav">
        <ul>
            
            <li><a href="/posts/about">关于我们</a></li>
            
            <li><a href="/posts">博文合集</a></li>
            
            <li><a href="/">网站首页</a></li>
            
        </ul>
    </nav>
    <footer class="footer">
    <span style="color: aliceblue;">© 2019-2023 by jobcher</span>
</footer>
</body>

</html>