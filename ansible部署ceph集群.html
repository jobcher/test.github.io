<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<link media="all" rel="stylesheet" href="./css/style.css">

<script src="./js/style.js"></script>



    <title>Ansible部署ceph集群 - 打工人日志</title>
</head>

<body>
    <div class="header-box">
    <img src="https://www.jobcher.com/images/logo.webp" id="logo" alt="logo" class="logo">
    <h1><a href="https://www.jobcher.com">打工人日志</a></h1>
</div>
<nav class="nav">
    <ul>
        
            <li>
                <a href="./">首页</a>
                
            </li>
        
            <li>
                <a href="https://nav.jobcher.com/">导航</a>
                
            </li>
        
            <li>
                <a href="./%E5%85%B3%E4%BA%8E%E6%88%91.html">关于</a>
                
            </li>
        
    </ul>
</nav>
    <div id="post" class="post">
        <header>
            <h2 class="post-title">Ansible部署ceph集群</h2>
            
                <img src="./images/ceph-logo.png" alt="Ansible部署ceph集群" class="featured-image">
            
        </header>
        <article class="article">
                <div class="single-content">
                    <h2 id="基础配置">基础配置</h2>
<p>三台环境为centos7.9，以下配置需要在每台机器上执行</p>
<h3 id="配置hosts解析">配置hosts解析</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>cat &gt;&gt; /etc/hosts <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.2.23 node1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.2.24 node2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.2.25 node3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><h3 id="关闭防火墙和selinux">关闭防火墙和selinux</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>systemctl stop firewalld <span style="color:#f92672">&amp;&amp;</span> systemctl disable firewalld
</span></span><span style="display:flex;"><span>setenforce <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> sed -i <span style="color:#e6db74">&#39;s/SELINUX=enforcing/SELINUX=disabled/g&#39;</span> /etc/selinux/config
</span></span></code></pre></div><h3 id="分别在三个节点设置主机名">分别在三个节点设置主机名</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>hostnamectl set-hostname node1
</span></span><span style="display:flex;"><span>hostnamectl set-hostname node2
</span></span><span style="display:flex;"><span>hostnamectl set-hostname node3
</span></span></code></pre></div><h3 id="配置主机时间同步">配置主机时间同步</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>systemctl restart chronyd.service <span style="color:#f92672">&amp;&amp;</span> systemctl enable chronyd.service
</span></span></code></pre></div><h3 id="配置免密登录">配置免密登录</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ssh-keygen
</span></span><span style="display:flex;"><span>ssh-copy-id -i .ssh/id_rsa.pub node1
</span></span><span style="display:flex;"><span>ssh-copy-id -i .ssh/id_rsa.pub node2
</span></span><span style="display:flex;"><span>ssh-copy-id -i .ssh/id_rsa.pub node3
</span></span></code></pre></div><h3 id="安装pip和ansiblegit">安装pip和ansible、git</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>yum install python-pip ansible git -y
</span></span></code></pre></div><h2 id="部署ceph集群">部署ceph集群</h2>
<h3 id="克隆存储库">克隆存储库</h3>
<p>这里我选择安装的是ceph nautilus版本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>git clone https://github.com/ceph/ceph-ansible.git
</span></span><span style="display:flex;"><span>cd ceph-ansible
</span></span><span style="display:flex;"><span>git checkout stable-4.0
</span></span></code></pre></div><h3 id="安装ansible依赖包">安装ansible依赖包</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>pip install --upgrade pip
</span></span><span style="display:flex;"><span>pip install -r requirements.txt
</span></span></code></pre></div><h3 id="修改hosts文件添加安装的节点">修改hosts文件，添加安装的节点</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>cat &gt;&gt; /etc/ansible/hosts <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[mons]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">node1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">node2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">node3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[osds]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">node1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">node2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">node3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[mgrs]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">node1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[mdss]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">node1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">node2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">node3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[clients]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">node1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">node2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">node3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[rgws]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">node1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">node2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">node3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[grafana-server]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">node1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><h3 id="备份group_vars下的yml文件">备份group_vars下的yml文件</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>cd ceph-ansible/group_vars
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> file in *;<span style="color:#66d9ef">do</span> cp $file <span style="color:#e6db74">${</span>file%.*<span style="color:#e6db74">}</span>;<span style="color:#66d9ef">done</span>
</span></span></code></pre></div><h3 id="修改group_varsallyml配置">修改group_vars/all.yml配置</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">dummy</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">mon_group_name</span>: <span style="color:#ae81ff">mons</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">osd_group_name</span>: <span style="color:#ae81ff">osds</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rgw_group_name</span>: <span style="color:#ae81ff">rgws</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">mds_group_name</span>: <span style="color:#ae81ff">mdss</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">client_group_name</span>: <span style="color:#ae81ff">clients</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">mgr_group_name</span>: <span style="color:#ae81ff">mgrs</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">grafana_server_group_name</span>: <span style="color:#ae81ff">grafana-server</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">configure_firewall</span>: <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">ceph_origin</span>: <span style="color:#ae81ff">repository</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">ceph_origin</span>: <span style="color:#ae81ff">repository</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">ceph_repository</span>: <span style="color:#ae81ff">community</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">ceph_mirror</span>: <span style="color:#ae81ff">http://mirrors.aliyun.com/ceph</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">ceph_stable_key</span>: <span style="color:#ae81ff">http://mirrors.aliyun.com/ceph/keys/release.asc</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">ceph_stable_release</span>: <span style="color:#ae81ff">nautilus</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">ceph_stable_repo</span>: <span style="color:#e6db74">&#34;{{ ceph_mirror }}/rpm-{{ ceph_stable_release }}&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">public_network</span>: <span style="color:#e6db74">&#34;192.168.2.0/24&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">cluster_network</span>: <span style="color:#e6db74">&#34;192.168.2.0/24&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">monitor_interface</span>: <span style="color:#ae81ff">ens33</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">osd_auto_discovery</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">osd_objectstore</span>: <span style="color:#ae81ff">filestore</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">radosgw_interface</span>: <span style="color:#ae81ff">ens33</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">dashboard_admin_password</span>: <span style="color:#ae81ff">asd123456</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">grafana_admin_password</span>: <span style="color:#ae81ff">admin</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">pg_autoscale_mode</span>: <span style="color:#66d9ef">True</span>
</span></span></code></pre></div><h3 id="修改group_varsosdsyml配置">修改group_vars/osds.yml配置</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">devices</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">/dev/sdb</span>
</span></span></code></pre></div><p>修改site.yml配置<br>
<img src="./images/ceph.png" alt="ceph-site"></p>
<h2 id="开始进行安装">开始进行安装</h2>
<p>剩下的交给时间吧，十分钟左右就装好了</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ansible-playbook -i /etc/ansible/hosts site.yml
</span></span></code></pre></div><p>查看安装状态，发现有一个警告，这是因为在之前的all.yml配置没有开启允许自动调整pool中的pg数 <code>pg_autoscale_mode: False</code> ，手动设置下即可</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ceph osd pool set &lt;pool-name&gt; pg_autoscale_mode on
</span></span></code></pre></div>
                </div>
            <br />
        <div>
                
                <a href="https://www.jobcher.com/cocoapods-%E5%AE%89%E8%A3%85%E5%8F%8A%E7%A2%B0%E5%88%B0%E9%97%AE%E9%A2%98.html" class="prev">前一页</a>
                
                
                <a href="https://www.jobcher.com/%E6%9C%80%E5%A5%BD%E7%9A%84%E5%BE%AE%E4%BF%A1%E6%9C%8B%E5%8F%8B%E5%9C%88%E9%9B%86%E8%B5%9E%E7%A5%9E%E5%99%A8-%E7%A6%8F%E5%88%A9%E6%8E%A8%E8%8D%90.html" class="next">后一页</a>
                
            </div>
        </article>
    </div>

    <nav class="footer-nav">
        <ul>
            
            <li><a href="./%E5%85%B3%E4%BA%8E%E6%88%91.html">关于我们</a></li>
            
            <li><a href="./">网站首页</a></li>
            
            <li><a href=""></a></li>
            
        </ul>
    </nav>
    <footer class="footer">
    <span style="color: aliceblue;">© 2019-2023 by jobcher</span>
</footer>
</body>

</html>